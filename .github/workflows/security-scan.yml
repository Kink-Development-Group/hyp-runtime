name: Security Scan

permissions:
  contents: read
  security-events: write
  actions: read

on:
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # SAST (Static Application Security Testing)
  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: security-extended,security-and-quality

      - name: Restore dependencies
        run: dotnet restore HypnoScript.sln
        working-directory: ${{ github.workspace }}

      - name: Build for CodeQL
        run: dotnet build HypnoScript.sln --configuration Release --no-restore
        working-directory: ${{ github.workspace }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
        continue-on-error: true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.sarif
          retention-days: 90

  # Dependency vulnerability scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: HypnoScript.Dokumentation/package-lock.json

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'HypnoScript'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Run Snyk security scan
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/dotnet@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json
        continue-on-error: true

      - name: Run npm audit
        working-directory: HypnoScript.Dokumentation
        run: |
          npm audit --audit-level=high --json > ../npm-audit-results.json || true

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            reports/
            snyk-results.json
            npm-audit-results.json
          retention-days: 90

  # Secret scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if base and head are different
        id: commit-check
        run: |
          BASE="${{ github.event.pull_request.base.sha || format('{0}~1', github.sha) }}"
          HEAD="${{ github.event.pull_request.head.sha || github.sha }}"

          echo "BASE=$BASE" >> $GITHUB_OUTPUT
          echo "HEAD=$HEAD" >> $GITHUB_OUTPUT

          if [ "$BASE" == "$HEAD" ]; then
            echo "same_commits=true" >> $GITHUB_OUTPUT
            echo "Base and head commits are identical ($BASE), skipping TruffleHog scan."
          else
            echo "same_commits=false" >> $GITHUB_OUTPUT
            echo "Base: $BASE, Head: $HEAD - proceeding with TruffleHog scan."
          fi

      - name: Run TruffleHog
        if: steps.commit-check.outputs.same_commits == 'false'
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: ${{ steps.commit-check.outputs.BASE }}
          head: ${{ steps.commit-check.outputs.HEAD }}
          extra_args: --only-verified

      - name: Skip TruffleHog (identical commits)
        if: steps.commit-check.outputs.same_commits == 'true'
        run: |
          echo "::notice::TruffleHog scan skipped - base and head commits are identical"

      - name: Check for hardcoded secrets (refined)
        run: |
          # Check for actual hardcoded secrets with more specific patterns
          # Look for assignment patterns with string literals containing potential secrets
          echo "Scanning for potential hardcoded secrets..."

          SECRET_FOUND=false

          # Check for password assignments
          if grep -r -E 'password\s*[:=]\s*["'"'"'][a-zA-Z0-9!@#$%^&*()_+{}|:<>?~`\-=\[\]\\;'"'"'",./]{8,}["'"'"']' --include="*.cs" --include="*.json" --include="*.config" --include="*.xml" . | grep -v -E '(test|example|sample|demo|placeholder|xxx|password123|default|template)'; then
            echo "::warning::Potential hardcoded password found"
            SECRET_FOUND=true
          fi

          # Check for API key assignments
          if grep -r -E 'api[_-]?key\s*[:=]\s*["'"'"'][a-zA-Z0-9!@#$%^&*()_+{}|:<>?~`\-=\[\]\\;'"'"'",./]{16,}["'"'"']' --include="*.cs" --include="*.json" --include="*.config" --include="*.xml" . | grep -v -E '(test|example|sample|demo|placeholder|your-api-key|api-key-here)'; then
            echo "::warning::Potential hardcoded API key found"
            SECRET_FOUND=true
          fi

          # Check for secret assignments
          if grep -r -E 'secret\s*[:=]\s*["'"'"'][a-zA-Z0-9!@#$%^&*()_+{}|:<>?~`\-=\[\]\\;'"'"'",./]{16,}["'"'"']' --include="*.cs" --include="*.json" --include="*.config" --include="*.xml" . | grep -v -E '(test|example|sample|demo|placeholder|client-secret-here|your-secret)'; then
            echo "::warning::Potential hardcoded secret found"
            SECRET_FOUND=true
          fi

          # Check for token assignments
          if grep -r -E 'token\s*[:=]\s*["'"'"'][a-zA-Z0-9!@#$%^&*()_+{}|:<>?~`\-=\[\]\\;'"'"'",./]{20,}["'"'"']' --include="*.cs" --include="*.json" --include="*.config" --include="*.xml" . | grep -v -E '(test|example|sample|demo|placeholder|your-token|access-token-here)'; then
            echo "::warning::Potential hardcoded token found"
            SECRET_FOUND=true
          fi

          if [ "$SECRET_FOUND" == "true" ]; then
            echo "::error::Potential hardcoded secrets detected. Please review the findings above."
            exit 1
          else
            echo "::notice::No hardcoded secrets detected"
          fi

      - name: Check for exposed credentials in connection strings
        run: |
          # Check for connection strings with embedded credentials
          echo "Scanning for connection strings with embedded credentials..."

          if grep -r -i 'connectionstring.*password\s*=\s*[^;]*[a-zA-Z0-9]{6,}' --include="*.cs" --include="*.json" --include="*.config" --include="*.xml" . | grep -v -E '(test|example|sample|demo|placeholder|\$\{|\%\{|@)'; then
            echo "::warning::Connection string with embedded password found"
            exit 1
          fi

          echo "::notice::No exposed connection string credentials detected"

  # Container security (if applicable)
  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'Dockerfile') || contains(github.event.head_commit.added, 'Dockerfile')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'hypnoscript:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-results
          path: trivy-results.sarif
          retention-days: 90

  # Infrastructure security
  infrastructure-security:
    name: Infrastructure Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload infrastructure scan results
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-scan-results
          path: checkov-results.sarif
          retention-days: 90

  # Security report generation
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs:
      [
        sast,
        dependency-scan,
        secret-scan,
        container-security,
        infrastructure-security,
      ]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all scan results
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: Generate security report
        run: |
          cat > security-report.md << EOF
          # Security Scan Report

          Generated on: $(date -u)

          ## ðŸ” Scan Summary

          ### SAST Analysis
          - **Status**: ${{ needs.sast.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          - **CodeQL**: Completed
          - **Semgrep**: Completed

          ### Dependency Scanning
          - **Status**: ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          - **OWASP Dependency Check**: Completed
          - **Snyk**: Completed
          - **npm audit**: Completed

          ### Secret Scanning
          - **Status**: ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          - **TruffleHog**: Completed

          ### Container Security
          - **Status**: ${{ needs.container-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          - **Trivy**: Completed

          ### Infrastructure Security
          - **Status**: ${{ needs.infrastructure-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          - **Checkov**: Completed

          ## ðŸš¨ Critical Issues

          No critical security issues detected.

          ## ðŸ”§ Recommendations

          1. Keep dependencies updated
          2. Review security scan results regularly
          3. Implement security best practices
          4. Monitor for new vulnerabilities

          ---

          *This report was automatically generated by the security scan workflow.*
          EOF

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 90

  # Security alerts
  security-alerts:
    name: Security Alerts
    runs-on: ubuntu-latest
    needs: [sast, dependency-scan, secret-scan, security-report]
    if: |
      needs.sast.result == 'failure' ||
      needs.dependency-scan.result == 'failure' ||
      needs.secret-scan.result == 'failure'

    steps:
      - name: Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸš¨ Security Issues Detected

            Security scan has detected potential issues that require attention.

            ### ðŸ“Š Scan Results
            - **SAST**: ${{ needs.sast.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Dependency Scan**: ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Secret Scan**: ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}

            ### ðŸ” Investigation Required
            1. Review the security scan artifacts
            2. Address any critical vulnerabilities
            3. Update dependencies if needed
            4. Remove any exposed secrets

            ### ðŸ“ˆ Security Score
            - **Overall**: ${{ (needs.sast.result == 'success' && needs.dependency-scan.result == 'success' && needs.secret-scan.result == 'success') && 'Good' || 'Needs Attention' }}

            ---

            *This issue was automatically created by the security scan workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security Issues Detected',
              body: body,
              labels: ['security', 'automated', 'high-priority']
            });

  # Security notification
  notify:
    name: Security Notification
    runs-on: ubuntu-latest
    needs:
      [sast, dependency-scan, secret-scan, security-report, security-alerts]
    if: always()

    steps:
      - name: Notify Discord
        if: |
          needs.sast.result == 'failure' ||
          needs.dependency-scan.result == 'failure' ||
          needs.secret-scan.result == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: 'Security Issues Detected'
          description: 'Security scan has detected issues that require attention.'
          color: 'ff0000'
