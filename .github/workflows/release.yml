name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1

jobs:
  # Build and Package Job
  build-and-package:
    name: Build and Package
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            package-type: deb
            package-extension: .deb
          - os: windows-latest
            package-type: zip
            package-extension: .zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Restore dependencies
        run: dotnet restore HypnoScript.sln

      - name: Build solution
        run: dotnet build HypnoScript.sln --configuration Release --no-restore

      - name: Run tests
        run: dotnet test HypnoScript.sln --configuration Release --no-build --verbosity normal

      - name: Publish CLI
        run: |
          dotnet publish HypnoScript.CLI \
            --configuration Release \
            --runtime ${{ matrix.os == 'windows-latest' && 'win-x64' || 'linux-x64' }} \
            --self-contained true \
            --output ./publish/${{ matrix.os }}

      - name: Generate Builtins Documentation
        run: |
          dotnet run --project HypnoScript.Runtime/Builtins/DocGenerator.cs HypnoScript.Dokumentation/docs/builtins/

      - name: Build Windows ZIP package
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $packageName = "HypnoScript-windows-x64-$version.zip"

          # Create package directory
          New-Item -ItemType Directory -Force -Path "package"

          # Copy files
          Copy-Item -Path "publish/windows-latest/*" -Destination "package/" -Recurse
          Copy-Item -Path "README.md" -Destination "package/"
          Copy-Item -Path "LICENSE" -Destination "package/" -ErrorAction SilentlyContinue
          Copy-Item -Path "CLI_README.md" -Destination "package/" -ErrorAction SilentlyContinue

          # Create ZIP
          Compress-Archive -Path "package/*" -DestinationPath "publish/$packageName" -Force

          # Calculate SHA256
          $hash = Get-FileHash -Path "publish/$packageName" -Algorithm SHA256
          $hash.Hash | Out-File -FilePath "publish/$packageName.sha256" -Encoding ASCII

          echo "package_name=$packageName" >> $env:GITHUB_OUTPUT
          echo "package_path=publish/$packageName" >> $env:GITHUB_OUTPUT
          echo "sha256_path=publish/$packageName.sha256" >> $env:GITHUB_OUTPUT

      - name: Build Linux DEB package
        if: matrix.os == 'ubuntu-latest'
        run: |
          version="${{ steps.version.outputs.version }}"
          package_name="hypnoscript_${version}_amd64.deb"

          # Install fpm
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential
          sudo gem install --no-document fpm

          # Create package structure
          mkdir -p package/usr/local/bin
          mkdir -p package/usr/share/doc/hypnoscript
          mkdir -p package/usr/share/man/man1

          # Copy files
          cp publish/ubuntu-latest/* package/usr/local/bin/
          cp README.md package/usr/share/doc/hypnoscript/
          cp LICENSE package/usr/share/doc/hypnoscript/ 2>/dev/null || true
          cp CLI_README.md package/usr/share/doc/hypnoscript/ 2>/dev/null || true

          # Make executable
          chmod +x package/usr/local/bin/*

          # Create DEB package
          fpm -s dir -t deb \
            --name hypnoscript \
            --version "$version" \
            --description "HypnoScript - Die hypnotische Programmiersprache" \
            --maintainer "HypnoScript Team <team@hypnoscript.dev>" \
            --url "https://github.com/Kink-Development-Group/hyp-runtime" \
            --license MIT \
            --category devel \
            --architecture amd64 \
            --package "publish/$package_name" \
            -C package .

          # Calculate SHA256
          sha256sum "publish/$package_name" | awk '{print $1}' > "publish/$package_name.sha256"

          echo "package_name=$package_name" >> $GITHUB_OUTPUT
          echo "package_path=publish/$package_name" >> $GITHUB_OUTPUT
          echo "sha256_path=publish/$package_name.sha256" >> $GITHUB_OUTPUT

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.os }}
          path: |
            publish/*.zip
            publish/*.deb
            publish/*.sha256
          retention-days: 90

  # Create Release Job
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-and-package
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Generate release notes
        id: release_notes
        run: |
          version="${{ steps.version.outputs.version }}"

          # Get commits since last release
          if git tag --sort=-version:refname | head -n 2 | tail -n 1; then
            last_tag=$(git tag --sort=-version:refname | head -n 2 | tail -n 1)
            commits=$(git log --pretty=format:"- %s" $last_tag..HEAD)
          else
            commits=$(git log --pretty=format:"- %s" --reverse)
          fi

          # Create release notes
          cat > release_notes.md << EOF
          # HypnoScript v$version Release

          ## ðŸš€ What's New

          This release includes various improvements and bug fixes.

          ## ðŸ“¦ Downloads

          - **Windows**: [HypnoScript-windows-x64-$version.zip](https://github.com/Kink-Development-Group/hyp-runtime/releases/download/v$version/HypnoScript-windows-x64-$version.zip)
          - **Linux (Debian/Ubuntu)**: [hypnoscript_${version}_amd64.deb](https://github.com/Kink-Development-Group/hyp-runtime/releases/download/v$version/hypnoscript_${version}_amd64.deb)

          ## ðŸ”§ Installation

          ### Windows
          \`\`\`powershell
          winget install HypnoScript.HypnoScript
          \`\`\`

          ### Linux
          \`\`\`bash
          sudo apt update
          sudo apt install hypnoscript
          \`\`\`

          ## ðŸ“ Changelog

          $commits

          ## ðŸ”— Links

          - [Documentation](https://Kink-Development-Group.github.io/hyp-runtime/)
          - [GitHub Repository](https://github.com/Kink-Development-Group/hyp-runtime)
          - [Issues](https://github.com/Kink-Development-Group/hyp-runtime/issues)
          EOF

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: HypnoScript v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: false
          files: |
            packages/*/*.zip
            packages/*/*.deb
            packages/*/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update winget manifest
  update-winget:
    name: Update winget Manifest
    runs-on: ubuntu-latest
    needs: create-release
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows package
        uses: actions/download-artifact@v4
        with:
          name: packages-windows-latest
          path: packages

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256 for winget
        run: |
          version="${{ steps.version.outputs.version }}"
          package_file="packages/HypnoScript-windows-x64-$version.zip"
          sha256=$(sha256sum "$package_file" | awk '{print $1}')
          echo "sha256=$sha256" >> $GITHUB_OUTPUT

      - name: Update winget manifest
        run: |
          version="${{ steps.version.outputs.version }}"
          sha256="${{ steps.sha256.outputs.sha256 }}"

          # Update version and SHA256 in winget manifest
          sed -i "s/Version: .*/Version: $version/" scripts/winget-manifest.yaml
          sed -i "s/Sha256: .*/Sha256: $sha256/" scripts/winget-manifest.yaml

          # Create PR to winget-pkgs repository
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add scripts/winget-manifest.yaml
          git commit -m "Update winget manifest for v$version" || exit 0
          git push origin HEAD:update-winget-v$version

      - name: Create winget PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: hypnoscript-update-v${{ steps.version.outputs.version }}
          title: 'Add HypnoScript v${{ steps.version.outputs.version }}'
          body: |
            This PR adds HypnoScript v${{ steps.version.outputs.version }} to winget.

            - Version: ${{ steps.version.outputs.version }}
            - SHA256: ${{ steps.sha256.outputs.sha256 }}
            - Download URL: https://github.com/Kink-Development-Group/hyp-runtime/releases/download/v${{ steps.version.outputs.version }}/HypnoScript-windows-x64-${{ steps.version.outputs.version }}.zip

            Please review and merge if everything looks good.
          path: scripts/winget-manifest.yaml
          commit-message: 'Add HypnoScript v${{ steps.version.outputs.version }}'

  # Notify success
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, update-winget]
    if: always()

    steps:
      - name: Notify Discord
        if: needs.create-release.result == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: 'HypnoScript Release Successful'
          description: 'Version ${{ github.ref_name }} has been released successfully!'
          color: '00ff00'
